# Docker Compose Override para desarrollo local
# Configuraciones específicas para el entorno de desarrollo

version: '3.8'

services:
  entradas-api:
    environment:
      # Configuración de desarrollo más verbosa
      ASPNETCORE_ENVIRONMENT: Development
      Serilog__MinimumLevel__Default: Debug
      Serilog__WriteTo__0__Name: Console
      Serilog__WriteTo__1__Name: File
      Serilog__WriteTo__1__Args__path: /app/logs/entradas-api-.log
      Serilog__WriteTo__1__Args__rollingInterval: Day
      Serilog__WriteTo__1__Args__retainedFileCountLimit: 7
      
      # Configuración de Entity Framework para desarrollo
      EntityFramework__EnableSensitiveDataLogging: true
      EntityFramework__EnableDetailedErrors: true
      
      # Configuración de CORS para desarrollo
      Cors__AllowedOrigins: "http://localhost:3000,http://localhost:5173"
      
    volumes:
      # Montar código fuente para hot reload (opcional)
      - ./Entradas.API:/app/source:ro
      # Logs persistentes
      - ./logs:/app/logs
      # Configuración de desarrollo
      - ./appsettings.Development.json:/app/appsettings.Development.json:ro
    
    # Configuración de debugging
    ports:
      - "8080:8080"
      - "5000:5000"  # Puerto adicional para debugging
    
    # Variables de debugging
    environment:
      DOTNET_USE_POLLING_FILE_WATCHER: true
      ASPNETCORE_LOGGING__CONSOLE__DISABLECOLORS: false

  postgres:
    environment:
      # Configuración adicional para desarrollo
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C --auth-local=trust"
    volumes:
      # Scripts de inicialización adicionales
      - ./scripts/dev-seed-data.sql:/docker-entrypoint-initdb.d/99-seed-data.sql:ro
    ports:
      # Exponer puerto para herramientas de desarrollo
      - "5432:5432"

  rabbitmq:
    environment:
      # Configuración de desarrollo con más logging
      RABBITMQ_LOG_LEVEL: debug
      RABBITMQ_LOGS: "-"
      RABBITMQ_SASL_LOGS: "-"
    volumes:
      # Configuración personalizada para desarrollo
      - ./scripts/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro

  # Herramientas de desarrollo adicionales
  pgadmin:
    image: dpage/pgadmin4:8.2
    container_name: entradas-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@entradas.local
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "8090:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - entradas-network
    depends_on:
      - postgres
    restart: unless-stopped

volumes:
  pgadmin_data:
    driver: local